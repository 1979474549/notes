# SSL/TLS 协议

> 其实这一块知识我是大致了解的，包括证书啊，验证，加密什么的，但对于具体的通信过程还有很多疑惑，我看网上众说纷纭，后续需要自己去研究一下。

    SSL/TLS是一个安全通信框架，上面可以承载HTTP，SMTP/POP3协议等

## TLS 协议的组成

- TLS 握手协议
- TLS 记录协议

### 握手协议

通过客户端和服务端的交互，共享信息，生成密钥，交换证书。
为什么要做这么繁琐的事情，其实是为了解决几个不安全的问题：

- 窃听
- 篡改
- 冒充

对应的解决方案是

- 加密通信
- 验证
- 证书

握手协议的步骤大致如下：
![](https://pic4.zhimg.com/80/v2-5aff714cb0cd14387cfad488adef97db_1440w.jpg)

看起来非常复杂，但是大致分为三个部分：

1. 服务端向客户端返回一个公钥和服务端生成的随机数。
2. 服务端要获得一个由客户端传输的随机数，和另一个用公钥加密的随机数。
3. 客户端和服务端通过三个随机数生成主密码，并切换该密码进行正常的 http 通信。

细说一下

1. client 向 server 发送 hello，包括可用的 TLS 版本号，当前时间，客户端随机数，会话 id，可用的加密方式，可用的压缩方式，这一步是明文传输。
2. server 向 client 发送 hello，包括和 client 一致的信息，用于回答 client 的问题（可用的加密方式，压缩方式等），也是明文传输。
3. server 向 client 发送证书，证书中含有公钥信息。
   当证书信息不足时，有两种处理情况
   - RSA 加密下，则返回 RSA 加密中的公钥密码参数。RSA 算法？
   - Diffie-Hellman 加密下，则传递密钥交换的参数。Dissie-Hellman？？
4. 在一个受限访问的环境中，服务端需要向客户端索取证书。
5. server done

到这里第一部分就完成了，然后 client 就要用公钥和服务端随机数做事了。

1. 如果服务端需要证书，则把证书发给服务端。
2. 向服务器传递由公钥加密的新的客户端随机数。
3. 如果服务端证书信息不足，且传来的是对应加密方式下的信息，则客户端需要向服务端传递预备主密码，这里对应服务端有两种情况：
   - RSA 加密下，客户端通过自己生成的新的随机数和服务端生成的随机数生成一个预备主密码，然后将预备主密码通过公钥加密，传输给服务端。
   - 其他方式加密，按照其他加密方式要求将预备主密码传输给服务端。

主密码是根据密码套件中定义的**单向散列函数**（hash 函数，常见的如 MD5，SHA 等）实现的**伪随机数生成器**（PRNG） +预备主密码+客户端随机数+服务器端随机数生成的。

预备主密码由新的客户端随机数和服务端随机数确定

主密码主要用来生成对称密码的密钥，消息认证码的密钥和对称密码的 CBC 模式所使用的初始化向量。

### 记录协议

记录协议用于消息的压缩，加密和认证
